<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:tr="http://myfaces.apache.org/trinidad"
                xmlns:trh="http://myfaces.apache.org/trinidad/html"
                xmlns:c="http://java.sun.com/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:ebi="http://ebi.ac.uk/faces/components"
                xmlns:ebisf="http://www.ebi.ac.uk/faces/site">

<tr:document title="#{config.title}">

<tr:form id="mainForm" inlineStyle="padding: 10px;">

<tr:panelGroupLayout layout="vertical">

<!-- To avoid expired sessions, poll every 15 mins -->
<tr:poll interval="#{15*60*1000}"/>

<tr:statusIndicator id="status">
    <f:facet name="busy">
        <tr:panelGroupLayout layout="horizontal">
            <tr:image source="/skins/ebi/images/status_busy_redback.gif"
                      inlineStyle="vertical-align:middle"/>
            <tr:outputFormatted value="&#160;"/>
            <tr:outputText value="Loading..."/>
        </tr:panelGroupLayout>
    </f:facet>
</tr:statusIndicator>

<ui:include src="/pages/search/search_panel.xhtml"/>

<tr:panelGroupLayout>
    <tr:messages id="errorMsg"/>
</tr:panelGroupLayout>

<tr:panelGroupLayout rendered="#{not searchBean.clusterSelected}">

<table style="width:100%; height: 200px">
<!--<table>-->
    <tr>
        <td style="vertical-align: top;">
            <!--Services-->
            <tr:panelHorizontalLayout rendered="#{searchBean.totalResults == 0}">

                <h:outputText style="color: red; font-weight: bold"
                              value="No results were found for this query#{searchBean.selectedServicesCount lt fn:length(searchBean.activeServiceNames)? ' for the selected services' : ''}."
                              rendered="#{searchBean.selectedServicesCount != 0}"/>
                <h:outputText style="color: red; font-weight: bold"
                              value="Select at least one service from the list below!"
                              rendered="#{searchBean.selectedServicesCount == 0}"/>
            </tr:panelHorizontalLayout>

            <tr:panelHorizontalLayout rendered="#{searchBean.totalResults gt 0}">
                <f:facet name="separator">
                    <tr:spacer width="4px"/>
                </f:facet>
                <tr:outputText
                        value="Click on the links below to display the results for each selected service "/>
            </tr:panelHorizontalLayout>

            <tr:spacer height="4px"/>

            <h:panelGroup>
                <tr:outputText
                        value="Use the check boxes to include or excludes services from the search and cluster operations - Select: "/>
                <tr:commandLink id="selectAllLink" text="All"
                                onclick="psicquic_selectAll(#{fn:length(searchBean.allServiceNames)})"/>
                <tr:outputText value=", "/>
                <tr:commandLink id="selectNoneLink" text="None"
                                onclick="psicquic_selectNone(#{fn:length(searchBean.allServiceNames)})"/>
            </h:panelGroup>

            <tr:spacer height="16px"/>

            <tr:panelFormLayout id="servicesTable" rows="#{config.serviceRows}" maxColumns="4">
                <c:forEach var="name" items="${searchBean.allServiceNames}" varStatus="status">
                    <tr:panelHorizontalLayout>

                        <h:graphicImage id="serviceStatusOn_${status.index}"
                                        alt="Status: ONLINE" title="Status: ONLINE"
                                        url="/images/greenLight.png"
                                        rendered="#{searchBean.servicesMap[name].active and not (searchBean.resultCountMap[name] lt '0')}"/>
                        <h:graphicImage id="serviceStatusOff_${status.index}"
                                        alt="Status: OFFLINE" title="Status: OFFLINE"
                                        url="/images/greyLight.png"
                                        rendered="#{not searchBean.servicesMap[name].active}"/>
                        <h:graphicImage id="serviceStatusWarn_${status.index}"
                                        alt="Status: WARNING"
                                        title="Status: WARNING - This service can not respond to the query"
                                        url="/images/orangeLight.png"
                                        rendered="#{searchBean.servicesMap[name].active and (searchBean.resultCountMap[name] == '-1')}"/>
                        <h:graphicImage id="serviceStatusErr_${status.index}"
                                        alt="Status: ERROR"
                                        title="Status: ERROR - This service has an unexpected error"
                                        url="/images/redLight.png"
                                        rendered="#{searchBean.servicesMap[name].active and (searchBean.resultCountMap[name] == '-2')}"/>


                        <h:selectBooleanCheckbox id="serviceSel_${status.index}"
                                                 value="#{searchBean.serviceSelectionMap[name]}"
                                                 disabled="#{not searchBean.servicesMap[name].active}"/>

                        <h:commandLink id="serviceLink_${status.index}" value="#{name}"
                                       styleClass="#{searchBean.selectedServiceName == name ? 'resultLink-selected' : ''}"
                                       onclick="_gaq.push(['_trackEvent', 'Database', '#{name}', '#{searchBean.userQuery.searchQuery}']);"
                                       disabled="#{not searchBean.servicesMap[name].active
                                                           or searchBean.resultCountMap[name] == 0
                                                           or searchBean.resultCountMap[name] == -2
                                                           or not searchBean.serviceSelectionMap[name]}"
                                       style="#{searchBean.selectedServiceName == name ? 'font-weight:bold; text-decoration: none' : ''}">
                            <f:setPropertyActionListener value="#{name}"
                                                         target="#{searchBean.selectedServiceName}"/>
                            <ui:param name="service" value="#{searchBean.servicesMap[name]}"/>
                        </h:commandLink>
                        <tr:spacer width="2px"/>

                        <h:outputLink id="serviceURL_${status.index}"
                                      value="#{searchBean.servicesMap[name].organizationUrl}" target="_blank">
                            <tr:image source="/images/external_link.gif"
                                      shortDesc="Organization URL"/>
                        </h:outputLink>
                        <tr:spacer width="2px"/>

                        <h:panelGroup id="resultsCounts" rendered="#{searchBean.resultCountMap[name] != null}">
                            &#160;-&#160;
                            <tr:outputText value="#{searchBean.resultCountMap[name]}" styleClass="resultCount"
                                           rendered="#{searchBean.resultCountMap[name] ge '0'}">
                                <tr:convertNumber pattern="#,###"/>
                            </tr:outputText>
                            <tr:outputText value="Timed out" styleClass="resultCount"
                                           rendered="#{searchBean.resultCountMap[name] == '-1'}"/>
                            <tr:outputText value="Error" styleClass="resultCount"
                                           rendered="#{searchBean.resultCountMap[name] == '-2'}"/>
                        </h:panelGroup>
                        <tr:spacer width="5px"/>

                    </tr:panelHorizontalLayout>
                </c:forEach>
            </tr:panelFormLayout>
        </td>
        <!--<td style="vertical-align: middle; text-align: center">-->
        <!--&lt;!&ndash;Download All Button&ndash;&gt;-->
        <!--<tr:commandButton id="downloadAllButtonMain"-->
        <!--shortDesc="This button will is enable with less than 300.000 interactions"-->
        <!--action="dialog:download.all"-->
        <!--useWindow="true"-->
        <!--windowWidth="600" windowHeight="500"-->
        <!--partialSubmit="true"-->
        <!--returnListener="#{downloadAllController.forward}"-->
        <!--disabled="#{searchBean.totalResults lt 0 or searchBean.totalResults gt 300000 or searchBean.clusterSelected}"-->
        <!--text="Download All"/>-->
        <!--</td>-->
        <td style="vertical-align: middle; text-align: center">
            <!--Cluster Button-->
            <tr:panelFormLayout rows="2" maxColumns="1">
                <tr:panelGroupLayout inlineStyle="height: 100%; width: 100% ;">
                    <tr:commandButton id="clusterButton"
                                      action="#{clusteringBean.start}"
                                      rendered="#{searchBean.totalResults > 0}"
                                      disabled="#{searchBean.totalResults > config.clusteringSizeLimit}"
                                      text="Cluster this query"/>   <!-- partialSubmit="true" -->

                    <tr:commandLink action="dialog:help.clustering" partialSubmit="true"
                                    rendered="#{searchBean.totalResults > 0}"
                                    windowWidth="600" windowHeight="500" immediate="true"
                                    useWindow="true">
                        <tr:image source="/images/question.jpeg" inlineStyle="vertical-align:middle;"
                                  shortDesc="#{clusteringBean.clusterButtonHelpMessage}"/>
                    </tr:commandLink>
                </tr:panelGroupLayout>
                <tr:panelGroupLayout>
                    <!-- Refresh the clustering status message every 5 secs when there are jobs to be displayed -->
                    <tr:panelGroupLayout partialTriggers="clusterButton">
                    <tr:panelGroupLayout rendered="#{not searchBean.clusterSelected and userJobs.jobCount gt 0}">
                        <tr:poll id="clusteringStatus" interval="5000"/>
                    </tr:panelGroupLayout>
                    </tr:panelGroupLayout>

                    <tr:panelBox id="jobListBox" text=" Status of your cluster queries" background="light"
                                 icon="/images/li.gif"
                                 rendered="#{userJobs.jobCount gt 0 and not searchBean.clusterSelected}"
                                 partialTriggers="clusteringStatus"> <!-- ,clusterButton -->

                        <tr:table value="#{userJobs.refreshedJobs}" var="job">
                            <tr:column>
                                <tr:outputText value="#{job.miql}" inlineStyle="text-overflow: ellipsis"/>
                            </tr:column>
                            <tr:column inlineStyle="white-space: nowrap;">
                                <tr:outputText value="#{job.status}" shortDesc="#{job.statusMessage}"/>
                            </tr:column>
                            <tr:column inlineStyle="white-space: nowrap;">
                                <tr:panelHorizontalLayout>
                                    <!-- View Job -->
                                    <tr:commandLink action="#{clusteringBean.viewJob}" text="view"
                                                    rendered="#{job.status == 'COMPLETED'}">
                                        <f:param name="jobId" value="#{job.jobId}"/>
                                    </tr:commandLink>
                                    <tr:outputText value="view" rendered="#{job.status != 'COMPLETED'}"/>
                                    <tr:outputText value="&#160;|&#160;"/>
                                    <!-- Remove Job -->
                                    <tr:commandLink action="#{clusteringBean.removeJob}" text="remove">
                                        <f:param name="jobId" value="#{job.jobId}"/>
                                    </tr:commandLink>
                                </tr:panelHorizontalLayout>
                            </tr:column>
                        </tr:table>
                    </tr:panelBox>
                </tr:panelGroupLayout>
            </tr:panelFormLayout>
        </td>
        <td style="text-align: right; vertical-align: top">
            <!--Legend and Total-->
            <table style="width:100%; height: 100%">
                    <tr>
                    <td align="right" style="vertical-align: top;">
                        <h:panelGroup>
                            <tr:outputText value="Total: "/>
                            <tr:outputText value="#{searchBean.totalResults} "
                                           inlineStyle="background-color:white; font-weight: bold; " >
                                <f:convertNumber pattern="#,###"/>
                            </tr:outputText>
                            <tr:outputText
                                    value="#{searchBean.clusterSelected ? ' clustered' : ' '} binary interactions"/>
                        </h:panelGroup>
                    </td>
                </tr>

                <tr>
                    <td align="right" style="vertical-align: bottom;">
                        <tr:panelBox background="light" text="Status of the service">
                            <ui:include src="search/legend.xhtml"/>
                        </tr:panelBox>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

</tr:panelGroupLayout>

<tr:panelGroupLayout rendered="#{searchBean.totalResults gt 0 and searchBean.clusterSelected}">
    <table>
        <tr>
            <td align="middle"><tr:image source="/images/back_arrow.gif"/></td>
            <td align="middle"><tr:commandLink action="#{searchBean.unselectClusterJob}"
                                               text="Back to all services"/>
            </td>
        </tr>
    </table>
</tr:panelGroupLayout>


<c:forEach var="name" items="${searchBean.allServiceNames}" varStatus="forStatus">
    <tr:panelGroupLayout id="serviceTable_${forStatus.index}" rendered="#{searchBean.selectedServiceName == name}"
                         partialTriggers="servicesTable">
        <tr:outputText value="#{searchBean.selectedServiceName}" inlineStyle="font-weight:bold; font-size:16px"/>
        <tr:separator/>
        <ui:include src="tabs/tabs.xhtml"/>
    </tr:panelGroupLayout>
</c:forEach>

</tr:panelGroupLayout>

</tr:form>
</tr:document>
</ui:composition>
